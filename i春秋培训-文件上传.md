# 非法文件上传漏洞技术解析及防御

## 第一章  上传技术基础

### 0x00  再现杰奇网站漏洞环境
* 实验思路
  1. 找到上传点
  2. 尝试上传图片和木马
  3. 删除验证方式绕过上传
  4. 修改过滤白名单绕过上传

* 判断是在服务器验证还是本地验证
当点击上传时，非常快速的返回了错误信息，所以验证没有发送到服务器端，而是在本地进行了验证。
很多情况下感觉速度较快的返回信息则认为有可能是本地验证，但是有的时候需要根据抓报以及跟踪上传代码来分析出是否为本地验证。

* 上传方法一：删除验证方式绕过上传（firebug）
通过firebug将页面中的上传框架进行删除，页面就不会在本地对上传类型做出验证了。 onsubmit=....

* 上传方法二：修改过滤白名单绕过上传
将上传的文件的类型，添加到页面允许上传的文件类型中去

* ！！上传漏洞防御
  1. 客户端检测，使用js对上传图片检测，包括文件大小、文件扩展名、文件类型等
  2. 服务端检测，对文件大小、文件路径、文件扩展名、文件类型、文件内容检测，对文件重命名
  3. 其他限制，服务器端上传目录设置不可执行权限（这样即使攻击者绕过了客户端检测和服务端检测，将webshell上传到了服务器端，也是没有执行权限，不能实现攻击的）

### 0X01   MIME类型检测绕过类上传漏洞
* MIME： 浏览器与服务端通信中头部信息组成的一部分，它是服务器用来判断浏览器传递文件格式的重要标记项。由于其为浏览器也就是客户端传递出去的，那么恶意用户就可以修改MIME以达到控制服务器的权限。

* 提示错误：文件类型不正确
这样就可以确定，它判断的是文件的类型
* 防御方案:
  1.客户端检测，使用JS对上传图片检测，包括文件大小、文件扩展名、文件类型等
  2.服务端检测，对文件大小、文件路径、文件扩展名、文件类型、文件内容检测，对文件重命名
  3.其他限制，服务器端上传目录设置不可执行权限

### 0X02   文件扩展名绕过漏洞
  * 通常客户端或服务端会对文件扩展名进行检测，但是如果没有此类检测或检测不完善的话，会造成极大的危害。

  * 不同的环境需要选取与环境匹配的一句话<br>
  一句话是一种常见的网站后门，短小精悍,而且功能强大，隐蔽性非常好，在渗透测试过程中始终扮演着强大的作用。<br>
  一句话中$_POST[‘这里是密码’]
  * php语言除了可以解析以php为后缀的文件，还可以解析php2、php3、php4、php5这些后缀的文件。

### 0X03   文件内容检测绕过类上传漏洞
  * 判断通过文件内容进行检测：
    本身上传PHP不可以，修改后缀为.jpg也不可以。<br>
    因此，最有可能，服务器端是通过文件内容进行验证

  * 我们再将图片文件上传一次，返回查看被截断的数据包，在末尾加上几个空格后粘贴一句话，然后修改文件名的尾缀为.php利于之后使用中国菜刀进行连接。

  * 空格的作用主要用于隔开图片文件和一句话，避免一句话解析混乱。
  * 如果不修改尾缀上传上去的文件仍然是.jpg，则仍以.jpg解析，那么就无法执行PHP脚本（也就是一句话执行失败）。

### 0X04  空字节截断目录路径检测绕过类上传漏洞
  * 打开Burpsuite抓包，进行截断浏览器给服务器发送的数据包，Proxy->Intercept 点击 intercept off 改为intercept on，截断的数据包将在关闭抓包的时候发送给服务端。
  * filename后面的信息是我们本地的地址
  * uploading是我们保存的地址
  * 将uploading改为uploading/1.php .jpg（注意php与.之间有一个空格）
  * 来到 Proxy->intercept->Hex， 就可以看到数据包用十六进制显示的样子
  * 20(也就是空格字符的16进制)改成00(也就是一个截断字符的16进制）这样以来。截断字符后面的都会被截断，也就是忽略掉了，所以uploading/1.php .jpg 就变成了uploading/1.php


## 第二章  解析导致的上传漏洞

### 0X00  IIS6.0站上的目录路径检测解析绕过上传漏洞

  * 绝大部分的用户使用的服务器都是Windows2003，而当中又有绝大部分的用户使用IIS6,这样就存在一个致命的漏洞,黑客非常容易就能入侵你的服务器。IIS6.0解析漏洞的利用方法，通常有两种，一种是文件解析，另一种是目录解析。之前已经介绍过文件解析的方法，本次课程将为大家讲解目录解析。该漏洞安全隐患较大，可导致网站的管理权限被盗、网站被黑。
  
  * 当网站是ASP类型时，需要使用ASP一句话木马。一句话中<%eval request["这里是密码"]%>。
    1. Content-Disposition:form-data;name=”path”下面的一行为服务保存文件的相对路径，我们把原本的 uploading/ 改为 uploading/1.asp/, 即在目录uploading/后面加上1.asp/，就将保存路径改为保存在uploading的1.asp下面了
    2. 再将filename="yijuhua.asp"改为yijuhua.jpg
    3. 上传后的整体目录就为： http://www.test.com/uploading/1.asp/yijuhua.jpg
  
  * 【！原理】：因为IIS解析漏洞会将这个地址探测到斜杠/时认为这里有一个截断，就会将斜杠后面这一段都给注释掉，不会对它进行解析，因此会把木马文件按'1.asp'格式进行解析。
  
  * 【？】以下哪个文件(或目录)不可以在iis6.0上以asp脚本执行执行   .asp  .asa .xhtml .cer



###0X01  IIS6.0站上的解析缺陷绕过上传漏洞
  * uploading/  ：文件上传的保存路径    filename="木马的名字"  
  在路径后面加上1.php;
  
  * 这样我们上传之后，文件的名字就会变成1.php;143534.jpg
  
  * 【！原理】：IIS解析漏洞，原理是首先会从左往右先找第一个点.，找到这一个点，然后获取这个点后面的后缀，就是.php;143534.jpg这么一大串，然后再继续找到分号;，搜索到分号之后，会认为这里有一个内存截断，然后就把分号后面的东西全部截断掉不会进行解析了。<br>
  这个文件的名称呢，IIS就会以1.php进行解析了<br>
  要记住，1.php;必须要在文件路径处进行修改，如果直接在filename里进行修改的话，上传之后，它有一个自动修改名称，将名称改为时间戳
  
  * 要注意它自动在uploading目录下生成了一个1.php的文件夹，但是我们的木马并不在这个文件夹里，它还是在原来的文件夹里，和这个1.php文件夹是同级的


### 0X02  Apache站上的解析缺陷绕过上传漏洞
  * Apache的解析漏洞主要特性为Apache是从后面开始检查后缀，按最后一个合法后缀执行，整个漏洞的关键就是Apache的合法后缀到底是哪些，不是合法后缀的都可以被利用，所以将木马的后缀进行修改为允许上传的类型后，即可成功绕过验证，最终拿到权限。
  
  * 【！原理】：因为Apache会对所有允许的后缀进行一个设置，设置它的后缀是以什么格式进行解析的，比如说它设置了jpg是以图片格式进行解析的，上传jpg文件后就以图片格式解析；设置了PHP格式是以php格式解析的，上传之后按照PHP格式解析。<br>
  对每一个后缀进行设置，如果它在Apache中没有设置这个后缀是以什么格式进行解析的话呢，它就会对这个格式进行忽略，而以前面的后缀来进行解析。<br>
  比如1.php.7z就解析成了1.php


### 0X03  htaccess文件上传解析漏洞

  * 有些服务器在上传认证没有拦截.htaccess文件上传，而导致恶意用户利用上传.htaccess文件解析漏洞，绕过验证进行上传WEBShell，从而达到控制网站服务器的目的。
  
  * 上传.htaccess文件
    1. 打开记事本，编写代码AddType application/x-httpd-php .jpg，然后点击文件选中另存为，编写文件名为.htaccess，选择保存类型为所有文件。
    2. .htaccess文件里的代码的含义 是 将上传的文件后缀名为.jpg格式的文件以 php格式来解析文件。
    3. 将.htaccess文件进行上传,上传成功。
    4. .htaccess是apache服务器中的一个配置文件,不是上传的文件的黑名单之内 ,所以.htaccess文件是可以上传成功。
  
  * 把一句话文件的后缀名为yijuhua.php改为后缀名为jpg格式 <br>
  上传成功到服务器的.htaccess文件里的代码可以让 .jpg后缀名文件格式的文件名以 php格式解析 所以我们把yijuhua.php文件的后缀名改为.jpg格式,让.htaccess文件解析 yijuhua.jpg文件里的php代码 ,使木马上传成功。


##第三章  上传漏洞之编辑器篇

### 0X00  FCK编辑器”版本识别及信息收集技术演示
  * “FCKeditor编辑器”是许多WEB页面都会采用的编辑器，例如百度空间里面的发表文章的文本编辑器，就是使用的FCKeditor编辑器。
  
  1. 查看FCK版本地址：
    + /_whatsnew.html(包含历史版本)
    + /_samples/default.html
  
  2. 个版本相应的上传点地址：
    * FCKeditor v2.4.2
      + /editor/filemanager/browser/default/connectors/test.html
      + /editor/filemanager/upload/test.html
    * FCKeditor v2.6.6
      + /editor/filemanager/connectors/test.html
      + /editor/filemanager/connectors/uploadtest.html
<br
<br>
<br>



#Web漏洞讲解—上传漏洞


  * 检测类型：
    1. 客户端javascript检测（个人PC主机）【通常为检测文件扩展名】
    2. 服务端MIME类型检测（WEB服务器）【检测content-type内容】
    3. 服务端目录路径检测（WEB服务器）【检测跟path参数相关的内容】
    4. 服务端文件扩展名检测（WEB服务器）【检测跟文件extension相关的内容】
    5. 服务端文件内容检测（WEB服务器）【检测内容是否合法或含有恶意代码】
  
  * 突破方法：
    + 针对客户端JS检测：<br>
    【原理】：通常一个文件以HTTP协议进行上传时，将以post请求发送至web服务器，web服务器接收到请求后并同意后，用户与web服务器将建立链接，并传输data。
      - a.保存到本地，将验证类型的js代码直接删掉再上传；
      - b.抓包后改文件后缀上传
  
  * 启示： 通常我们以白名单的形式来写限制，而不要以黑名单的方式写（容易出安全事故），把危险的扩展名删掉像cer php5423

<br>

###0X00 客户端检测绕过（javascript检测）
  * 在本地可以看到js代码，改个扩展名
  * 一般可以解析的如PHP、ASP都是会过滤掉的， 但可能忘记像.cer .php2345  .asa这些类型（可以代替PHP和asp执行）



###0X01 服务端验证绕过（MIME类型检测）
  * 服务端检测MIME，主要代码如下：
  
  ```
  <?php 
    if($.FILES['userfile']['type'])!=image/gif){ //检测Content-Type
    echo "sorry.we only allow uploading GIF images";
    exit;
  }
  ?>
  ```
   
  * 绕过方法：抓包 改Content-Type:text/plain 为Content-Type:image/gif 即改成允许的类型就好（主要是看对方服务器的代码怎么写：允许什么类型）



###0X02 服务端检测绕过（目录路径检测）

  * 00截断：在.jpg前面加一个空格，利用空字符截断，后面的.jpg就去掉了；
  但是在判断时，是根据后面来判断，是.jpg就允许上传了。检测，一般就检测是否合法，稍微特殊一点的都没有防御。
    + 案例： http://www.wooyun.org/bugs/wooyun-2010-01684
  
  * 因为对目录路径的检测不够严谨而导致可以用0X00截断进行攻击
    + 案例： 在最后将要进行写文件之前的变量状态：<br>
     sFilePath = C:/wamp/www/userfiles/image/fuck.php .gif/fvck.gif(.php后面是0X00)<br>
     当执行move_uploaded_file($oFile['tmp_name'], $sFilePath)这个函数时<br>
     先将sFilePath写入到指定位置，但是底层操作应该是调用的类似于C语言，遇到0X00会自动截断，所以真正写入的实际地址是C:/wamp/www/userfiles/image/fuck.php
  
  * 【参考文章】：www.2cto.com/Article/201403/284289.html
  * 【推荐软件】：edjpgcom.exe :专门用来在图片中插入一句话木马
  
  * 【！启示】：  在网站目录下创建123.php、123.asp这类文件夹是非常非常危险的，上传进来的任何文件都可以以.php、.asp的格式解析



###0X03 服务端检测绕过（黑名单）

  * 黑名单的安全性比白名单的低很多，攻击手法自然也比白名单多，一般有个专门的blacklist文件，里面也会包含常见的危险脚本文件。

  1. 文件名大小写绕过<br>
  用像AsP, pHp之类的文件名绕过黑名单检测（Windows系统不区分大小写；Linux系统区分大小写）

  2. 名单列表绕过<br>
  用黑名单里没有的名单进行攻击，比如黑名单没有.asa或.cer之类

  3. 特殊文件名绕过<br>
  比如发送的http包里把文件名改成test.asp. 或test.asp_（下划线为空格），这种命名方式在Windows系统里是不被允许的，所以需要在burp之类里进行修改，然后绕过验证后，会被Windows系统自动去掉后面的点和空格，但要注意Unix/Linux系统没有这个特性。

  4. 0X00截断绕过<br>
  检测这一块目前我只遇到过asp 的程序有这种漏洞，给个简单的伪代码：<br>
  name = getname(http request) //假如这时候获取到的文件名是test.asp .jpg（asp后面是0X00）<br>
  type = gettype(name) //而在gettype()函数里处理方式是从后往前扫描扩展名，所以判断为jpg<br>
  if(type == jpg)<br>
  SavaFileToPath(UploadPath.name, name) //但在这里却是以0X00作为文件名截断 //最后以test.asp存入路径里

  5. 双扩展名解析绕过攻击(1) — 基于web服务的解析逻辑<br>
  在Apache里面用的最多，Apache解析文件的时候是从后往前解析的<br>
  如果上传一个文件名为help.asp.123首先扩展名123并没有在扩展名blacklist里，然后扩展名123也没有在Apache可解析扩展名list里，这个时候它会向前搜寻下一个可解析扩展名，或搜寻到.php，最后会以php执行

  6. 双扩展名解析绕过攻击（2）— 基于web服务的解析方式<br>
   如果在Apache的conf里有这样一行配置 AddHandler php5-script .php 这时只要文件名里包含.php即使文件名是test2.php.jpg也会以php来执行。
     * 【！启示】：做安全，默认配置是很重要的，相当重要，尤其是Apache的配置文件，比如Apache配置文件里面允许了AddHandler php5-script .php这一行，就是非常危险的

  7. 危险解析绕过攻击 — 基于web服务的解析方式<br>
   如果在Apache的conf 里有这样一行配置 AddType application/x-httpd-php .jpg   即使扩展名是jpg，一样能以php方式执行
     * 【！启示】：操作系统加固，除了数据库加固，还有中间站？加固很多很多

  8. .htaccess文件攻击<br>
  配合名单列表绕过，上传一个自定义的.htaccess，就可以轻松绕过各种检测（可在网上搜更多进行了解）

  9. 解析调用/漏洞绕过<br>
  这类漏洞直接配合上传一个代码注入过的黑名单文件即可，再利用解析调用/漏洞 



####0X04 服务器检测绕过（白名单）
  * 相对来说比黑名单安全一些，但也不见得就绝对安全了

  1. 0X00截断绕过<br>
  用像test.asp%00.jpg的方式进行截断，属于白名单文件，再利用服务端的检测逻辑漏洞进行攻击，目前我只遇到过asp的程序有这种漏洞

  2. 解析调用/漏洞绕过<br>
  这类漏洞直接配合上传一个代码注入过的白名单文件即可，再利用解析调用/漏洞（想方设法把想上传的文件的扩展名加入到白名单列表里面去）

  3. htaccess文件攻击<br>
  无论是黑名单还是白名单，直接点就是直接攻击.htaccess文件<br>
     1.  提供一个代码:<br>
    
      ```
      <FilesMatch "haha">
        SetHandler application/x-httpd-php
      </FileMatch>
      ```
    
      2. 然后准备一个名叫haha的一句话木马，内容如下:<br>
      "haha" <?php @eval($_POST['1']);?><br>
      只要一句话木马的名字包含haha就能够当作php文件解析了，一句话木马的内容一定要包含.htaccess里面定义的"haha"



####0X05 服务端检测绕过（文件内容检测）
  * 属于代码层，如果设置的非常严密，白名单黑名单都严格了，又没有解析漏洞服务器打了最新补丁，基本上就没有什么办法了。
  
  * 如果文件内容检测设置的比较严格，那么上传攻击变得非常困难，也可以说它是在代码层检测的最后一道关卡，如果它被土炮了，就算没有代码层的漏洞了，也给后面利用应用层的解析漏洞带了了机会。<br>
  我们这里主要以最常见的图像类型内容检测来举例：
  
  1. 文件幻数检测（文件头检测）<br>
  主要是检测文件内容开始处的文件幻数，比如图片类型的文件幻数（文件头信息）如下：
    * 要绕过jpg文件幻数检测就要在文件开头加上：FF D8 FF E0 10  4A 46 49 46  （对应为yoya JFIF）
    * 要绕过gif文件幻数检测就要在文件开头加上：47 49 46 38 39 61 (对应为GIF89a)
    * 要绕过png文件幻数检测就要在文件开头加上：89 50 4E 47(对应| png)
  
    * 然后在文件幻数后面加上自己的一句话木马代码即可
    * 推荐工具： edjpgcom.exe 自动将一句话木马加到图片空白的地方
  
  2. 文件相关信息检测
   * 图像文件相关信息检测常用的就是getimagesize()函数，只需要把文件头部分伪造好就OK了，就是在文件幻数的基础上还加了一些文件信息，有点像下面的结构：
  
   ```
   GIF89a
   (...some binary data for image...)
   <?php phpinfo(); ?>//在空格处插入的一句话木马
   (...skipping the rest of binary data ...)
   ```

  3. 文件加载检测
     * 这个是最变态的检测了，一般是调用API或函数去进行文件加载测试，常见的是图像渲染测试，再变态点的甚至是进行二次渲染（后面会提到）。对渲染/加载测试的攻击方式是代码注绕过：对二次渲染的攻击方式是攻击文件加载器自身。
     * 先说下对渲染/加载测试攻击—代码注入绕过，可以用图像处理软件对一张图片进行代码注入。用winhex看数据可以分析出这类工具的原理是在不破坏文件本身的渲染情况下找一个空白区进行填充代码，一般会是图片的注释区。对于渲染测试基本上都能绕过，毕竟本身的文件结构是完整的。
     * ！！！这里就强烈推荐用edjpgcom.exe这款软件了，不是双击使用，而是将图片拖到这个软件上就可以使用了。
     * 但如果碰到变态的二次渲染。基本上就没法绕过了，估计就只能对文件加载器进行攻击了。下面来介绍二次渲染：
        + 二次渲染，相当于是把原本属于图像数据的部分抓了出来，再用自己的API或函数进行重新渲染，在这个过程中非图像数据的部分就被直接隔离开了。
        + 能想到的一个思路就是基于数据二义性，即让数据既是图像数据也包含一句话木马，就像shellcode通过数据二义性绕过IDS检测特殊字符一样的道理，但是我现在还不知道怎么构造出这样的图像文件。
        + 如果要对文件加载器进行攻击，常见的就是溢出攻击，上传自己的恶意文件后，服务器上的文件加载器会主动进行加载测试，加载测试时被溢出攻击执行shellcode。？？？？？



####0X06  解析攻击（4类解析漏洞总结）
  * 四类解析漏洞：
      * Apache的扩展名顺序解析漏洞<br>
      这个是Apache自身的漏洞
      * IIS的asp解析漏洞<br>
      这个是IIS自身的漏洞
      * Nginx的%00解析漏洞<br>
      这个是Nginx的%00解析漏洞
      * PHP—CGI的默认配置漏洞<br>
      这类漏洞主要出现在IIS和Nginx，这类似CGI形式调用php的web应用程序，而Apache
  <br>

  * 我们以一个故事的方式来描述，方便大家能更深层次地理解一些渗透的本质，古时候，A国对B国进行攻城战，B国背后有一条水道，这时候会有以下情况：
      + 完全没有防御
      + 有一点简单的防御（用木头制成的门栏）
      + 有一定程度的防御（用金属制成的门栏）
      + 非常强的防御（几乎完全封闭死了）

  * 从攻击角度来分是这样的：
      + 一、直接解析（完全没有防御或有一点简单的防御）<br>
      比如我们直接就可以上传一个扩展名是.php的文件，只需要简单地绕过客户端javascript检测或者服务端MIME类型检测就行了。
      + 二、配合解析（有一定程度的防御）<br>
      我们可以理解为先代码注入到服务器上，上传一个带有一句话木马的图片或文件之类让它待在某个位置，等待这一个解析的配合。（比如php的文件包含解析，web服务器的解析漏洞，.htaccess解析等）
        1. 本地文件包含解析<br>
        主要是php的本地文件包含（远程文件包含不属于上传攻击绕过范畴）
        2. htaccess解析<br>
        就不用多说了，看看之前.htaccess文件攻击的那个案例，用户自己定义如何去调用解析器解析文件就可以了。
        3. web应用程序解析漏洞以及其原理
          - Apache解析漏洞(属于白名单绕过)
            * 解析：test.php.任意不属于黑名单且不属于Apache解析白名单的名称
            * 描述：一个文件名为x1.x2.x3的文件，Apache会从x3的位置往x1的位置开始尝试解析，如果x3不属于Apache能解析的扩展名，那么Apache会尝试去解析x2的位置，这样一直往前尝试，直到遇到一个能解析的扩展名为止
            * 测试：测试了下面这些集成环境，都以它们的最新版本来测试，应该能覆盖所有低版本：
              + WampServer2.0 All Version(WampServer2.0i/Apache2.2.11)[Success]
              + WampServer2.1 All Version(WampServer2.1e-x32/Apache2.2.17)[Success]
              + Wamp5 All Version(Wamp5_1.7.4/Apache2.2.6)[Success]
              + AppServ 2.4 All Version(AppServ-2.4.9/Apache 2.0.59)[success]
              + AppServ 2.5 All Version(AppServ-2.5.10/Apache 2.2.8)[success]
              + AppServ 2.6 All Version(AppServ-2.6.0/Apache 2.2.8)[success]
              +上面测试过的集成环境都有这个扩展名解析顺序漏洞，然后所有测试过的集成环境都有对php3扩展名按php解析这个小洞（本质上来说这个不算漏洞，只是在针对一些名单不全的黑名单时，能有绕过的机会）
              （版本还要等测试过才能具体知晓）
          - IIS解析漏洞
            * 解析：test.asp/任意文件名| test.asp;任意文件名| 任意文件名/任意文件名.php
            * 描述：IIS6.0在解析asp格式的时候有两个解析漏洞，一个是如果目录包含".asp"字符串，那么这个目录下所有的文件都会按照asp去解析，另一个是只要文件名中含有".asp;"会优先按asp来解析<br>
              IIs7.0/7.5是对php解析时有一个类似于Nginx的解析漏洞，对任意文件名只要在URL后面追加上字符串"/任意文件名.php"就会按照php的方式去解析(IIS6.0没测试)
            * 测试：测试了下面这些集成环境，都以它们的最新版本来测试，应该能覆盖所有低版本:
              + IIS6.0(Win2003 SP2 + IIS6.0)[success]
              + IIS7.0(Win2008 R1 + IIS7.0)[success]
              + IIS7.5(Win2008 R2 + IIS7.5)[success]
            * IIS的解析漏洞在市面上描述的版本还算明确，不像Apache那么模糊，针对IIS6.0只要文件名不被重命名基本都能搞定。这里要注意一点，对于任意文件名/任意文件名.php 这个漏洞其实是出现自php-cgi的漏洞，所以其实跟IIS自身是无关的，这个会在接下来讲到。
            * 资料： drops.wooyun.org/papers/539(解析漏洞总结)
            * 启示： 服务器一定要打最新的补丁
          - Nginx


####0X06  上传攻击框架
* 图1234567
* 防御：建议看一下DVWA安全级别高 的防御代码，写程序时参照这个来写，可以杜绝上传漏洞。上传漏洞是

